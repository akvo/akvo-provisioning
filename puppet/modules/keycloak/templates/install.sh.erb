#!/bin/bash

set -e


### Environment
FILES="http://files.support.akvo-ops.org/keycloak"
KEYCLOAK="${FILES}/keycloak-<%= @kc_release %>.tar.gz"
KEYCLOAK_THEME="${FILES}/themes.tar.gz"
POSTGRESQL_DRIVER="${FILES}/postgresql-<%= @psql_driver_release %>.jar"


### Fetch and unpack Keycloak
curl "${KEYCLOAK}" | tar xz


### Fetch and configure PostgreSQL JDBC driver
mkdir -p "<%= @psql_driver_dir %>"
cd "<%= @psql_driver_dir %>"
curl "${POSTGRESQL_DRIVER}"
saxon-xslt -o "<%= @config_file %>" "<%= @config_file %>" \
  "<%= @approot %>/configure.xsl"


### Fetch and configure custom Akvo theme
cd "<%= @appdir %>"
curl "${KEYCLOAK_THEME}" | tar xz


### We're probably done if we get this far!
touch "<%= @approot %>/.installed-keycloak-<%= @kc_release %>"
