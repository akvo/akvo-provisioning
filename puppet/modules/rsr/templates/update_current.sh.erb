#!/bin/bash

BRANCH=$1
ORIG_DIR=`pwd`
HERE="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

if [ -e <%= @approot %>/code ]
then
  echo 'already have a checkout'
  cd $HERE/code/
  git checkout $BRANCH
  git pull origin $BRANCH
  cd $ORIG_DIR
  PIP=<%= @approot %>/venv/bin/pip

  $PIP install -r <%= @approot %>/code/scripts/deployment/pip/requirements/2_rsr.txt
  # due to a stupid dependency of django-counter, both PIL and Pillow will be installed, so we'll remove them
  # here and reinstall
  $PIP uninstall --yes PIL Pillow
  $PIP install Pillow==2.0.0
else
  echo 'no checkout, will create'
  $HERE/make_app.sh inplace $BRANCH
  $HERE/make_current.sh $HERE/versions/inplace
fi