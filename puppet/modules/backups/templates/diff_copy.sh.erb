#!/bin/bash

# ======
# CONFIG
# ======

HOST=<%= @remote_host %>
PORT=<%= @port %>
USER=<%= @username %>
SOURCE_DIR=$1
PERIOD=$2
RETAIN_COUNT=$3
NAME=$4
BASE_DEST_DIR=<%= @dest_dir %>/<%= @environment %>/<%= @hostname %>/$NAME
SSH_COMMAND="ssh -p $PORT -i /backups/ssh/backup_key"


# ==========
# VALIDATION
# ==========

if [[ -z $SOURCE_DIR ]] || [[ -z $PERIOD ]] || [[ -z $RETAIN_COUNT ]] || [[ -z $NAME ]]
then
    echo "Usage: backup_to_<%=@name%>.sh source period retain_count name"
    exit 1
fi


# ====
# EXEC
# ====

echo "Backing up $SOURCE_DIR to <%=@name%>"

ON_REMOTE="$SSH_COMMAND $USER@$HOST"

# first clean up the old dirs
$ON_REMOTE rm -rf $BASE_DEST_DIR/$PERIOD/$RETAIN_COUNT

for i in $(seq $RETAIN_COUNT -1 1)
do
    PREV=`expr $i - 1`
    $ON_REMOTE mv $BASE_DEST_DIR/$PERIOD/$PREV $BASE_DEST_DIR/$PERIOD/$i
done

# hardlink to old files if possible
if [ "$?" -eq "1" ]
then
    # this means that the previous 'mv' failed, ie, there is no current backup
    # to link to
    LINK_DEST=''
else
    LINK_DEST="--link-dest=../1"
fi

# Now copy!
DEST_DIR=$BASE_DEST_DIR/$PERIOD/0
<% if @use_sftp %>
sftp -b - $USER@$HOST <<EOF >>/dev/null 2>&1
mkdir <%= @dest_dir %>
cd <%= @dest_dir %>
mkdir <%= @environment %>
cd <%= @environment %>
mkdir <%= @hostname %>
cd <%= @hostname %>
mkdir $NAME
EOF
<% else %>
$ON_REMOTE mkdir -p $DEST_DIR
$ON_REMOTE rm -f $BASE_DEST_DIR/$PERIOD/current
$ON_REMOTE ln -s $DEST_DIR $BASE_DEST_DIR/$PERIOD/current
<% endif %>

rsync --verbose --archive --delete ${LINK_DEST} --rsh "${SSH_COMMAND}" $SOURCE_DIR $USER@$HOST:$DEST_DIR/